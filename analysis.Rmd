---
title: "ASKED-IT"
author: "Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(knitr)

source("C:\\Users\\pylell\\Documents\\GitHub\\ASKEDIT\\ASKEDIT_R_2018-12-05_1420.r")

source("C:\\Users\\pylell\\Documents\\GitHub\\General-code\\temp_table1.r")

source("C:\\Users\\pylell\\Documents\\GitHub\\General-code\\01_functions.r")

#source("C:\\Users\\pylell\\Documents\\GitHub\\ASKEDIT\\ASKEDIT_R_2018-12-06_1058.r")
#source("C:\\Users\\pylell\\Documents\\GitHub\\ASKEDIT\\ASKEDIT_R_2018-12-06_1108.r")
# SMOD datasets are long, not wide


# collapse insurance to private vs. public
data$insnew[data$insurance==1] <- "Private"
data$insnew[data$insurance != 1 & data$insurance !=6] <- "Public"
data$insnew[data$insurance==6] <- "None"

# drop unused levels of group
data$redcap_event_name.factor <-  droplevels(data$redcap_event_name.factor)

# calculate deltas
data$d.mwikad3 <- data$mwikad3month - data$mwikadenroll
data$d.mwikad6 <- data$mwikad6month - data$mwikadenroll
data$d.a1c3 <- data$a1c3month - data$enrolla1c
data$d.a1c6 <- data$a1c6month - data$enrolla1c
data$d.bgtest3 <- data$bgtest3month - data$enrollbgfrequency
data$d.bgtest6 <- data$testing6month - data$enrollbgfrequency
data$d.high3 <- data$high3month - data$enrollhigh
data$d.high6 <- data$high6month - data$enrollhigh
data$d.low3 <-data$low3month - data$enrolllow
data$d.low6 <- data$low6month - data$enrolllow
data$d.inrange3 <- data$inrange3month - data$enrollinrange
data$d.inrange6 <- data$inrange6month - data$enrollinrange
data$d.smod3 <- data$totalsmod3month - data$totalenroll
data$d.smod6 <- data$totalsmod6month - data$totalenroll

# labels
label(data$nih_sex.factor)="Sex"
label(data$nih_race.factor)="Race"
label(data$ethnicity.factor)="Ethnicity"
label(data$insulindelivery.factor)="Insulin delivery"
label(data$cgm.factor)="CGM"
label(data$homes.factor)="Do you live in more than one home?"
label(data$income.factor)="Income"
label(data$insnew)="Insurance"
label(data$d.mwikad3)="Change in MWIKAD 3 mo"
label(data$d.mwikad6)="Change in MWIKAD 6 mo"
label(data$d.a1c3)="Change in A1c 3 mo"
label(data$d.a1c6)="Change in A1c 6 mo"
label(data$d.bgtest3)="Change in BG testing 3 mo"
label(data$d.bgtest6)="Change in BG testing 6 mo"
label(data$d.high3)="Change in % high 3 mo"
label(data$d.high6)="Change in % high 6 mo"
label(data$d.low3)="Change in % low 3 mo"
label(data$d.low6)="Change in % low 6 mo"
label(data$d.inrange3)="Change in % in range 3 mo"
label(data$d.inrange6)="Change in % in range 6 mo"
label(data$d.smod3)="Change in total SMOD 3 mo"
label(data$d.smod6)="Change in total SMOD 6 mo"
# not sure what is going on with SMOD - most of the values are m issing
# sent an email to Sonalee


# Table 1
tab1 <- final_table(data,c("age","nih_sex.factor","diab_durration","nih_race.factor","ethnicity.factor","insulindelivery.factor",
                           "cgm.factor","insnew","homes.factor","income.factor"),
                    group=as.factor(data$redcap_event_name.factor),margin=2,single=0,ron=1)

# Table 2 - table of changes
tab2 <- final_table(data,c("d.mwikad3","d.mwikad6","d.a1c3","d.a1c6","d.bgtest3","d.bgtest6","d.high3","d.high6",
                           "d.low3","d.low6","d.inrange3","d.inrange6")
                    ,group=as.factor(data$redcap_event_name.factor),margin=2,single=0,ron=1)

# ++++++++++++++++++++++++++++
# flattenCorrMatrix
# ++++++++++++++++++++++++++++
# cormat : matrix of the correlation coefficients
# pmat : matrix of the correlation p-values
flattenCorrMatrix <- function(cormat, pmat) {
  ut <- upper.tri(cormat)
  data.frame(
    row = rownames(cormat)[row(cormat)[ut]],
    column = rownames(cormat)[col(cormat)[ut]],
    cor  =(cormat)[ut],
    p = pmat[ut]
    )
}
corrout <- rcorr(as.matrix(data[, c("d.mwikad3","d.mwikad6","d.a1c3","d.a1c6","d.bgtest3","d.bgtest6","d.high3","d.high6",
                           "d.low3","d.low6","d.inrange3","d.inrange6","response_rate","response_rate_6_months")])
                  ,type = "spearman")
corrout <- flattenCorrMatrix(corrout$r, corrout$P)
corrout <- corrout[corrout$column=="response_rate" | corrout$column=="response_rate_6_months",]

```

# Background

The purpose of the ASKED-IT study is to test whether a texting intervention improves diabetes knowledge, self-care, and adherence.

# Methods

The distributions of all variables were examined prior to analysis.  Groups were compared using t-tests or Mann Whitney U-tests for continuous variables, and chi-square or Fisher's exact tests for categorical variables.  Spearman's correlation coefficient was used to examine the association between response rate and study outcomes in the intervention group.

# Results

Table 1 shows descriptive statistics by group.

```{r, results='asis',tidy=TRUE, echo=FALSE}
kable(tab1,caption="Table 1.  Descriptive statistics by group.")
```
\

Comparisons of changes in study outcomes are shown in Table 2.

```{r, results='asis',tidy=TRUE, echo=FALSE}
kable(tab2,caption="Table 2.  Changes in study outcomes by group.")
```
\

Correlations between study outcomes and response rates for participants in the intervention group are shown in Table 3.

```{r, results='asis',tidy=TRUE, echo=FALSE}
kable(corrout,caption="Table 2.  Correlations between study outcomes and response rates.  Changes in study outcomes are denoted with a 'd.' prior to the variable name.  The number at the end of the variable name indicates the time period over which the change was calculated.  For example, 'd.inrange3' is the change in the percent in range from enrollment to 3 months.")
```
\
